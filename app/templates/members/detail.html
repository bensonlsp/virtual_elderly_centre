{% extends "base.html" %}
{% block title %}{{ member.name_zh }} â€“ æœƒå“¡è©³æƒ…{% endblock %}
{% block page_title %}æœƒå“¡è©³æƒ…{% endblock %}

{% block content %}
<!-- Back + actions -->
<div class="flex items-center justify-between mb-6">
    <a href="/members/" class="btn btn-sm btn-ghost gap-1">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        è¿”å›åˆ—è¡¨
    </a>
    <div class="flex gap-2">
        <a href="/members/{{ member.id }}/edit" class="btn btn-sm btn-outline">ç·¨è¼¯</a>
        <form method="POST" action="/members/{{ member.id }}/delete" onsubmit="return confirm('ç¢ºå®šåˆªé™¤æ­¤æœƒå“¡ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤å›ã€‚')">
            <button type="submit" class="btn btn-sm btn-error btn-outline">åˆªé™¤</button>
        </form>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Profile card -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <div class="flex flex-col items-center text-center mb-4">
                <div class="avatar placeholder mb-3">
                    <div class="w-20 rounded-full bg-primary/15 text-primary text-2xl font-bold">
                        <span>{{ member.name_zh[0] }}</span>
                    </div>
                </div>
                <h2 class="text-xl font-bold">{{ member.name_zh }}</h2>
                <p class="text-base-content/50 text-sm">{{ member.name_en or '' }}</p>
                <span class="badge mt-2 {% if member.is_active %}badge-success{% else %}badge-ghost{% endif %}">
                    {% if member.is_active %}æ´»èº{% else %}éæ´»èº{% endif %}
                </span>
            </div>
            <div class="divider my-2"></div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span class="text-base-content/50">æ€§åˆ¥</span><span>{{ member.gender
                        }}</span></div>
                <div class="flex justify-between"><span class="text-base-content/50">å¹´é½¡</span><span>{{ member.age or 'â€“'
                        }} æ­²</span></div>
                <div class="flex justify-between"><span class="text-base-content/50">å‡ºç”Ÿæ—¥æœŸ</span><span>{{
                        member.dob.strftime('%Y-%m-%d') if member.dob else 'â€“' }}</span></div>
                <div class="flex justify-between"><span class="text-base-content/50">é›»è©±</span><span class="font-mono">{{
                        member.phone or 'â€“' }}</span></div>
                <div class="flex justify-between"><span class="text-base-content/50">å…¥æœƒæ—¥æœŸ</span><span>{{
                        member.joined_date.strftime('%Y-%m-%d') if member.joined_date else 'â€“' }}</span></div>
            </div>
            <div class="divider my-2"></div>
            <div class="text-sm">
                <p class="text-base-content/50 mb-1">åœ°å€</p>
                <p class="text-base-content leading-relaxed">{{ member.address or 'æœªå¡«å¯«' }}</p>
            </div>
        </div>
    </div>

    <!-- Right column: health, emergency, tabs -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Health & special needs -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="card bg-base-100 shadow-sm">
                <div class="card-body p-4">
                    <h3 class="font-semibold text-sm text-base-content/70 mb-2">èº«é«”ç‹€æ³</h3>
                    <p class="text-sm">{{ member.health_condition or 'ç„¡è¨˜éŒ„' }}</p>
                </div>
            </div>
            <div class="card bg-base-100 shadow-sm">
                <div class="card-body p-4">
                    <h3 class="font-semibold text-sm text-base-content/70 mb-2">ç‰¹æ®Šéœ€è¦</h3>
                    <p class="text-sm">{{ member.special_needs or 'ç„¡' }}</p>
                </div>
            </div>
        </div>

        <!-- Emergency contact -->
        {% set ec = member.emergency_contact %}
        {% if ec and ec.name %}
        <div class="card bg-warning/10 border border-warning/30 shadow-sm">
            <div class="card-body p-4">
                <h3 class="font-semibold text-sm text-warning-content mb-2">ğŸ†˜ ç·Šæ€¥è¯çµ¡äºº</h3>
                <div class="flex gap-6 text-sm">
                    <div><span class="text-base-content/50">å§“åï¼š</span>{{ ec.name }}</div>
                    <div><span class="text-base-content/50">é—œä¿‚ï¼š</span>{{ ec.relation }}</div>
                    <div><span class="text-base-content/50">é›»è©±ï¼š</span><span class="font-mono">{{ ec.phone }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tabs: activity history + respite records -->
        <div class="card bg-base-100 shadow-md" x-data="{ tab: 'activities' }">
            <div class="card-body">
                <div class="tabs tabs-boxed inline-flex mb-4">
                    <button class="tab" :class="tab === 'activities' ? 'tab-active' : ''" @click="tab = 'activities'">
                        æ´»å‹•æ­·å² ({{ member.registrations | length }})
                    </button>
                    <button class="tab" :class="tab === 'respite' ? 'tab-active' : ''" @click="tab = 'respite'">
                        æš«è¨—è¨˜éŒ„ ({{ member.respite_services | length }})
                    </button>
                </div>

                <!-- Activity history -->
                <div x-show="tab === 'activities'">
                    {% if member.registrations %}
                    <div class="overflow-x-auto">
                        <table class="table table-sm w-full">
                            <thead>
                                <tr class="text-base-content/50 text-xs">
                                    <th>æ´»å‹•åç¨±</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‡ºå¸­ç‹€æ…‹</th>
                                    <th>åé¥‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reg in member.registrations | sort(attribute='registered_at', reverse=True) %}
                                <tr class="hover">
                                    <td class="font-medium text-sm">
                                        <a href="/activities/{{ reg.activity_id }}" class="link link-hover">{{
                                            reg.activity.name }}</a>
                                    </td>
                                    <td class="text-xs text-base-content/50">{{
                                        reg.activity.datetime_start.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <span class="badge badge-xs
                      {% if reg.attendance.value == 'å·²å‡ºå¸­' %}badge-success
                      {% elif reg.attendance.value == 'ç¼ºå¸­' %}badge-error
                      {% elif reg.attendance.value == 'å·²å–æ¶ˆ' %}badge-ghost
                      {% else %}badge-primary{% endif %}">
                                            {{ reg.attendance.value }}
                                        </span>
                                    </td>
                                    <td class="text-xs text-base-content/50 max-w-xs truncate">{{ reg.feedback or 'â€“' }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-base-content/40 text-sm text-center py-6">å°šç„¡æ´»å‹•å ±åè¨˜éŒ„</p>
                    {% endif %}
                </div>

                <!-- Respite records -->
                <div x-show="tab === 'respite'" x-cloak>
                    {% if member.respite_services %}
                    <div class="overflow-x-auto">
                        <table class="table table-sm w-full">
                            <thead>
                                <tr class="text-base-content/50 text-xs">
                                    <th>æ—¥æœŸ</th>
                                    <th>æ™‚æ®µ</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rs in member.respite_services | sort(attribute='date', reverse=True) %}
                                <tr class="hover">
                                    <td class="text-sm">{{ rs.date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-sm">{{ rs.session.value }}</td>
                                    <td>
                                        <span class="badge badge-xs
                      {% if rs.status.value == 'å·²æ‰¹å‡†' %}badge-success
                      {% elif rs.status.value == 'å·²æ‹’çµ•' %}badge-error
                      {% else %}badge-warning{% endif %}">
                                            {{ rs.status.value }}
                                        </span>
                                    </td>
                                    <td class="text-xs text-base-content/50">{{ rs.notes or 'â€“' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-base-content/40 text-sm text-center py-6">å°šç„¡æš«è¨—è¨˜éŒ„</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if member.notes %}
        <div class="alert alert-info text-sm">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <p class="font-semibold">å‚™è¨»</p>
                <p>{{ member.notes }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}